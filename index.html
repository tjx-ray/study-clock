<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沉浸式作息表</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            margin: 0; padding: 0; background-color: black; color: white;
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100vh;
            transition: background-color 0.5s ease; overflow: hidden;
        }
        #start-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.95); display: flex;
            align-items: center; justify-content: center; z-index: 100; cursor: pointer;
        }
        #start-btn {
            font-size: 24px; color: white; border: 2px solid white;
            padding: 15px 30px; border-radius: 10px; background: transparent; cursor: pointer;
        }
        #title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
        #time-display { font-size: 5rem; font-weight: bold; color: #00BFFF; margin-bottom: 10px; font-family: 'Arial', sans-serif; }
        #next-event { font-size: 1.2rem; color: gray; margin-bottom: 40px; }
        #dynamic-text { font-size: 1.3rem; text-align: center; max-width: 90%; min-height: 60px; line-height: 1.5; padding: 0 20px; }
        .alert-bg { background-color: #330000 !important; }
        .quote-text { color: #FFD700; }
        .alert-text { color: #FF4500; font-size: 1.6rem !important; font-weight: bold; }
    </style>
</head>
<body>
    <div id="start-overlay" onclick="startApp()">
        <button id="start-btn">点击开启沉浸式复习</button>
    </div>
    <div id="title">沉浸ing...</div>
    <div id="time-display">00:00:00</div>
    <div id="next-event">加载中...</div>
    <div id="dynamic-text" class="quote-text">星光不问赶路人，时光不负有心人。</div>

    <script>
        // 注册离线 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }

        const SCHEDULE = [
            { time: "08:00", msg: "【上课啦】第一节课开始，集中注意力！" },
            { time: "08:40", msg: "【下课啦】第一节结束，休息5分钟" },
            { time: "08:45", msg: "【上课啦】第二节课开始，继续加油！" },
            { time: "09:25", msg: "【下课啦】第二节结束，休息5分钟" },
            { time: "09:30", msg: "【上课啦】第三节课开始，稳住！" },
            { time: "10:10", msg: "【大课间】第三节结束，休息25分钟！去喝水走走！" },
            { time: "10:35", msg: "【上课啦】第四节课开始，大课间结束啦！" },
            { time: "11:15", msg: "【下课啦】第四节结束，休息5分钟" },
            { time: "11:20", msg: "【上课啦】第五节课开始，上午最后一节！" },
            { time: "12:00", msg: "【干饭啦】上午课程结束，吃午饭+午休！" },
            { time: "14:00", msg: "【上课啦】第六节课开始，下午好！" },
            { time: "14:40", msg: "【下课啦】第六节结束，休息10分钟" },
            { time: "14:50", msg: "【上课啦】第七节课开始，保持清醒！" },
            { time: "15:30", msg: "【下课啦】第七节结束，休息10分钟" },
            { time: "15:40", msg: "【上课啦】第八节课开始，一鼓作气！" },
            { time: "16:20", msg: "【下课啦】第八节结束，休息10分钟" },
            { time: "16:30", msg: "【上课啦】第九节课开始，下午最后一节！" },
            { time: "17:10", msg: "【干饭啦】下午课程结束，吃晚饭+休整！" },
            { time: "18:30", msg: "【晚自习】晚一打铃，静下心来！" },
            { time: "19:30", msg: "【下课啦】晚一结束，休息10分钟" },
            { time: "19:40", msg: "【晚自习】晚二打铃，突破难点！" },
            { time: "20:40", msg: "【下课啦】晚二结束，休息10分钟" },
            { time: "20:50", msg: "【晚自习】晚三打铃，最后冲刺！" },
            { time: "21:50", msg: "【放学啦】全天复习结束，早点休息，明天继续！" }
        ];

        const QUOTES = [
            "星光不问赶路人，时光不负有心人。",
            "乾坤未定，你我皆是黑马。",
            "再多学一点，就离梦想更近一步。",
            "代码多敲一遍，电路图多画一次，专业课就能多拿一分！",
            "那些看似不起波澜的日复一日，会突然在某天让人看到坚持的意义。",
            "生医工的巅峰在向你招手，坚持住！",
            "现在的坚持，是为了将来的毫不费力。",
            "政治英语不用怕，数一数电稳扎稳打。",
            "疑行无成，疑事无功"
        ];

        let lastAlertedTime = ""; let alertEndTime = 0; let currentAlertMsg = "";
        let currentQuoteIdx = 0; let lastQuoteChange = Date.now();
        let audioCtx = null;
        const timeDisplay = document.getElementById("time-display");
        const nextEventDisplay = document.getElementById("next-event");
        const dynamicText = document.getElementById("dynamic-text");
        const body = document.body;

        function startApp() {
            document.getElementById("start-overlay").style.display = "none";
            if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
            checkTime(); setInterval(checkTime, 500);
        }

        // 声音+震动模块
        function playBeep() {
            // 1. 发出蜂鸣声
            if (audioCtx) {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start(); oscillator.stop(audioCtx.currentTime + 1);
            }
            // 2. 调用安卓/鸿蒙硬件震动 (震动1秒，停0.5秒，震动1秒)
            if (navigator.vibrate) {
                navigator.vibrate([1000, 500, 1000]);
            }
        }

        function checkTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentTimeStr = `${hours}:${minutes}`;
            const currentTimestamp = Date.now();

            timeDisplay.innerText = `${hours}:${minutes}:${seconds}`;

            let nextTime = "";
            for (let i = 0; i < SCHEDULE.length; i++) {
                if (currentTimeStr < SCHEDULE[i].time) { nextTime = SCHEDULE[i].time; break; }
            }
            nextEventDisplay.innerText = nextTime ? `下一个时间节点: ${nextTime}` : "今日复习节点已全部完成";

            for (let i = 0; i < SCHEDULE.length; i++) {
                if (currentTimeStr === SCHEDULE[i].time && lastAlertedTime !== currentTimeStr) {
                    lastAlertedTime = currentTimeStr;
                    alertEndTime = currentTimestamp + 120000;
                    currentAlertMsg = SCHEDULE[i].msg;
                    playBeep(); // 触发声音和震动
                }
            }

            if (currentTimestamp < alertEndTime) {
                body.classList.add("alert-bg");
                dynamicText.className = "alert-text";
                dynamicText.innerText = currentAlertMsg;
            } else {
                body.classList.remove("alert-bg");
                dynamicText.className = "quote-text";
                if (currentTimestamp - lastQuoteChange > 15000) {
                    currentQuoteIdx = (currentQuoteIdx + 1) % QUOTES.length;
                    lastQuoteChange = currentTimestamp;
                }
                dynamicText.innerText = QUOTES[currentQuoteIdx];
            }
        }
    </script>
</body>
</html>
